<!DOCTYPE html>
<html lang="en" x-data="galleryApp" x-cloak>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Studio Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
      [x-cloak] { display: none !important; }
    </style>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: { sans: ['Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'] },
            colors: {
              gray: {
                800: '#1f1f1f',
                900: '#0f0f0f'
              }
            }
          }
        }
      };
    </script>
    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.data('galleryApp', () => ({
          darkMode: true,
          galleryImages: [],
          filesToUpload: [],
          previews: [],
          isUploading: false,
          init() {
            document.documentElement.classList.add('dark');
            this.fetchImages();
            setInterval(() => this.fetchImages(), 3000);
          },
          fetchImages() {
            fetch('/api/images')
              .then(res => res.json())
              .then(data => this.galleryImages = data);
          },
          handleFileSelect(e) {
            this.filesToUpload = Array.from(e.target.files);
            this.previews = [];
            for (let file of this.filesToUpload) {
              const reader = new FileReader();
              reader.onload = e => this.previews.push({ name: file.name, url: e.target.result });
              reader.readAsDataURL(file);
            }
          },
          uploadFiles() {
            const formData = new FormData();
            this.filesToUpload.forEach(f => formData.append('files', f));
            this.isUploading = true;
            fetch('/upload', { method: 'POST', body: formData })
              .then(() => {
                this.isUploading = false;
                this.fetchImages();
                this.filesToUpload = [];
                this.previews = [];
              });
          },
          downloadPDF(key) {
            window.open(`/convert?key=${encodeURIComponent(key)}&format=pdf`, '_blank');
          }
        }));
      });
    </script>
  </head>
  <body class="bg-black text-white font-sans min-h-screen" x-init="init()">
    <header class="text-center py-6">
      <h1 class="text-2xl font-semibold uppercase tracking-widest">Image Studio Pro</h1>
      <p class="text-gray-400 tracking-wide text-sm uppercase">Upload. Enhance. Export.</p>
    </header>

    <main class="max-w-5xl mx-auto px-4">
      <section class="mb-10 text-center">
        <input type="file" multiple accept="image/*" class="hidden" id="fileInput" @change="handleFileSelect" x-ref="fileInput" />
        <div class="border-2 border-dashed border-white/20 p-10 rounded cursor-pointer" @click="$refs.fileInput.click()">
          <p class="text-gray-400">Click or drag images here to upload</p>
        </div>
        <div class="mt-4 flex flex-wrap justify-center gap-4" x-show="previews.length" x-cloak>
          <template x-for="preview in previews" :key="preview.name">
            <img :src="preview.url" class="h-24 rounded border border-white/20" />
          </template>
        </div>
        <button @click="uploadFiles" x-show="previews.length" class="mt-4 bg-white text-black px-4 py-2 rounded hover:bg-gray-300 transition" x-cloak>
          <span x-show="!isUploading">Upload</span>
          <span x-show="isUploading">Uploading...</span>
        </button>
      </section>

      <section x-show="galleryImages.length" x-cloak class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <template x-for="img in galleryImages" :key="img.original_key">
          <div class="bg-gray-800 rounded overflow-hidden shadow text-sm">
            <img :src="img.thumbnail_url" class="w-full h-40 object-cover" />
            <div class="p-3">
              <p class="truncate" x-text="img.original_key.split('/').pop()"></p>

                <div class="mt-3">
                  <label class="block text-xs text-gray-400 uppercase mb-1 px-3">
                    Format (<span x-text="img.metadata.basic.size || 'N/A'"></span>)
                  </label>
                  <select @change="event => {
                    const format = event.target.value;
                    if (format === 'pdf') {
                      downloadPDF(img.original_key);
                    } else {
                      window.open('/convert?key=' + encodeURIComponent(img.original_key) + '&format=' + format, '_blank');
                  }
                }}" class="w-full bg-black border border-white/20 rounded px-3 py-2 text-sm text-white">
                  <option value="">Select Format</option>
                  <option value="pdf">Download PDF</option>
                  <option value="jpeg">Convert to JPEG</option>
                  <option value="png">Convert to PNG</option>
                  <option value="webp">Convert to WebP</option>
                </select>
              </div>

                  <div>
                    <p class="text-xs text-gray-400 pt-2 px-3 uppercase">
                      Resolution (<span x-text="img.metadata.basic.size || 'N/A'"></span>)
                    </p>
                    <div class="flex gap-2 px-3 py-1">
                      <input type="number" min="1" placeholder="Width" x-model.number="img.resizeWidth" class="w-1/2 bg-black border border-white/20 rounded px-2 py-1 text-xs text-white" />
                      <input type="number" min="1" placeholder="Height" x-model.number="img.resizeHeight" class="w-1/2 bg-black border border-white/20 rounded px-2 py-1 text-xs text-white" />
                    </div>
                    <button @click="window.open('/resize?key=' + encodeURIComponent(img.original_key) + '&width=' + (img.resizeWidth || '') + '&height=' + (img.resizeHeight || ''), '_blank')" class="mt-1 bg-white text-black px-3 py-1 rounded text-xs hover:bg-gray-300 transition mx-3">
                      Resize
                    </button>
                  </div>

                  <div>
                    <p class="text-xs text-gray-400 pt-2 px-3 uppercase">Metadata</p>
                    <div class="bg-gray-700 rounded mx-3 mt-1 p-2 text-xs text-gray-200 space-y-1"
                         x-data="{
                           basic: Object.keys(img.metadata.basic || {}).length ? JSON.stringify(img.metadata.basic) : 'N/A',
                           enhanced: Object.keys(img.metadata.enhanced || {}).length ? JSON.stringify(img.metadata.enhanced) : 'N/A'
                         }">
                      <div><strong>Basic:</strong> <span x-text="basic"></span></div>
                      <div><strong>Enhanced:</strong> <span x-text="enhanced"></span></div>
                    </div>
                    <div class="px-3 pb-3 flex gap-2">
                      <a :href="img.original_url" target="_blank" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-2 rounded text-xs text-center">
                        Download
                      </a>
                      <form action="/delete" method="POST" class="flex-1">
                        <input type="hidden" name="key" :value="img.original_key" />
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded text-xs">Delete</button>
                      </form>
                    </div>
                  </div>
              </div>
            </div>
          </div>
        </template>
      </section>
    </main>
  </body>
</html>
